<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>文章大纲.md</title><style type='text/css'>html, body {overflow-x: initial !important;}.CodeMirror { height: auto; }
.CodeMirror-scroll { overflow-y: hidden; overflow-x: auto; }
.CodeMirror-lines { padding: 4px 0px; }
.CodeMirror pre { }
.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { background-color: white; }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-color: rgb(247, 247, 247); white-space: nowrap; }
.CodeMirror-linenumbers { }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.CodeMirror div.CodeMirror-cursor { border-left-width: 1px; border-left-style: solid; border-left-color: black; z-index: 3; }
.CodeMirror div.CodeMirror-secondarycursor { border-left-width: 1px; border-left-style: solid; border-left-color: silver; }
.CodeMirror.cm-keymap-fat-cursor div.CodeMirror-cursor { width: auto; border: 0px; background-color: rgb(119, 238, 119); z-index: 1; background-position: initial initial; background-repeat: initial initial; }
.CodeMirror div.CodeMirror-cursor.CodeMirror-overwrite { }
.cm-tab { display: inline-block; }
.cm-s-typora-default .cm-header, .cm-s-typora-default .cm-property { color: rgb(217, 79, 138); }
.cm-s-typora-default pre.cm-header1:not(.cm-atom) :not(.cm-overlay) { font-size: 2rem; line-height: 2rem; }
.cm-s-typora-default pre.cm-header2:not(.cm-atom) :not(.cm-overlay) { font-size: 1.4rem; line-height: 1.4rem; }
.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number { color: rgb(149, 132, 134); }
.cm-s-typora-default .cm-table-row, .cm-s-typora-default .cm-block-start { font-family: monospace; }
.cm-s-typora-default .cm-comment, .cm-s-typora-default .cm-code { color: rgb(74, 90, 159); font-family: monospace; }
.cm-s-typora-default .cm-tag { color: rgb(169, 68, 66); }
.cm-s-typora-default .cm-string { color: rgb(126, 134, 169); }
.cm-s-typora-default .cm-link { color: rgb(196, 122, 15); text-decoration: underline; }
.cm-s-typora-default .cm-variable-2, .cm-s-typora-default .cm-variable-1 { color: inherit; }
.cm-s-typora-default .cm-overlay { font-size: 1rem; font-family: monospace; }
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor { border-left-width: 3px; border-left-style: solid; border-left-color: rgb(228, 98, 154); }
.cm-s-typora-default .CodeMirror-activeline-background { left: -60px; right: -30px; background-color: rgba(204, 204, 204, 0.2); background-position: initial initial; background-repeat: initial initial; }
.cm-s-typora-default .CodeMirror-gutters { border-right-style: none; background-color: inherit; }
.cm-s-typora-default .cm-trailing-space-new-line::after, .cm-startspace::after, .cm-starttab .cm-tab::after { content: '•'; position: absolute; left: 0px; opacity: 0; font-family: LetterGothicStd, monospace; }
.os-windows .cm-startspace::after, .os-windows .cm-starttab .cm-tab::after { left: -0.1em; }
.cm-starttab .cm-tab::after { content: ' '; }
.cm-startspace, .cm-tab, .cm-starttab, .cm-trailing-space-a, .cm-trailing-space-b, .cm-trailing-space-new-line { font-family: monospace; position: relative; }
.cm-s-typora-default .cm-trailing-space-new-line::after { content: '↓'; opacity: 0.3; }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: black; }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-property { color: black; }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: blue; }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: bold; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: rgb(255, 0, 0); }
.cm-invalidchar { color: rgb(255, 0, 0); }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { margin-bottom: -30px; margin-right: -30px; padding-bottom: 30px; padding-right: 30px; height: 100%; outline: none; position: relative; box-sizing: content-box; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow-x: hidden; overflow-y: scroll; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow-y: hidden; overflow-x: scroll; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; border-width: 0px; background-color: transparent; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: initial initial; background-repeat: initial initial; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: -webkit-fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-widget { }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.CodeMirror-selected { background-color: rgb(217, 217, 217); background-position: initial initial; background-repeat: initial initial; }
.CodeMirror-focused .CodeMirror-selected { background-color: rgb(215, 212, 240); background-position: initial initial; background-repeat: initial initial; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); background-position: initial initial; background-repeat: initial initial; }
.CodeMirror span { }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}
.CodeMirror-lint-markers { width: 16px; }
.CodeMirror-lint-tooltip { background-color: infobackground; border: 1px solid black; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; color: infotext; font-family: monospace; overflow: hidden; padding: 2px 5px; position: fixed; white-space: pre-wrap; z-index: 10000; max-width: 600px; opacity: 0; -webkit-transition: opacity 0.4s; transition: opacity 0.4s; font-size: 0.8em; }
.CodeMirror-lint-mark-error, .CodeMirror-lint-mark-warning { background-position: 0% 100%; background-repeat: repeat no-repeat; }
.CodeMirror-lint-mark-error { background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg==); }
.CodeMirror-lint-marker-error, .CodeMirror-lint-marker-warning { cursor: pointer; display: inline-block; height: 16px; width: 16px; vertical-align: middle; position: relative; background-position: 50% 50%; background-repeat: no-repeat no-repeat; }
.CodeMirror-lint-message-error, .CodeMirror-lint-message-warning { padding-left: 18px; background-position: 0% 0%; background-repeat: no-repeat no-repeat; }
.CodeMirror-lint-marker-error, .CodeMirror-lint-message-error { background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAHlBMVEW7AAC7AACxAAC7AAC7AAAAAAC4AAC5AAD///+7AAAUdclpAAAABnRSTlMXnORSiwCK0ZKSAAAATUlEQVR42mWPOQ7AQAgDuQLx/z8csYRmPRIFIwRGnosRrpamvkKi0FTIiMASR3hhKW+hAN6/tIWhu9PDWiTGNEkTtIOucA5Oyr9ckPgAWm0GPBog6v4AAAAASUVORK5CYII=); }
.CodeMirror-lint-marker-warning, .CodeMirror-lint-message-warning { background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAANlBMVEX/uwDvrwD/uwD/uwD/uwD/uwD/uwD/uwD/uwD6twD/uwAAAADurwD2tQD7uAD+ugAAAAD/uwDhmeTRAAAADHRSTlMJ8mN1EYcbmiixgACm7WbuAAAAVklEQVR42n3PUQqAIBBFUU1LLc3u/jdbOJoW1P08DA9Gba8+YWJ6gNJoNYIBzAA2chBth5kLmG9YUoG0NHAUwFXwO9LuBQL1giCQb8gC9Oro2vp5rncCIY8L8uEx5ZkAAAAASUVORK5CYII=); }
.CodeMirror-lint-marker-multiple { background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAHCAMAAADzjKfhAAAACVBMVEUAAAAAAAC/v7914kyHAAAAAXRSTlMAQObYZgAAACNJREFUeNo1ioEJAAAIwmz/H90iFFSGJgFMe3gaLZ0od+9/AQZ0ADosbYraAAAAAElFTkSuQmCC); width: 100%; height: 100%; background-position: 100% 100%; background-repeat: no-repeat no-repeat; }


html { font-size: 14px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { background-color: rgb(181, 214, 252); text-shadow: none; background-position: initial initial; background-repeat: initial initial; }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; padding-bottom: 70px; white-space: pre-wrap; overflow-x: auto; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
.typora-export #write { margin: 0px auto; }
#write > p:first-child, #write > ul:first-child, #write > ol:first-child, #write > pre:first-child, #write > blockquote:first-child, #write > div:first-child, #write > table:first-child { margin-top: 30px; }
#write li > table:first-child { margin-top: -20px; }
img { max-width: 100%; vertical-align: middle; }
input, button, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
::before, ::after, * { box-sizing: border-box; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write div, #write pre { width: inherit; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6 { position: relative; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
p { -webkit-margin-before: 1rem; -webkit-margin-after: 1rem; -webkit-margin-start: 0px; -webkit-margin-end: 0px; }
.mathjax-block { margin-top: 0px; margin-bottom: 0px; -webkit-margin-before: 0rem; -webkit-margin-after: 0rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: bold; font-style: italic; }
a { cursor: pointer; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; margin: 4px 0px 0px; }
tr { page-break-inside: avoid; page-break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; page-break-inside: auto; text-align: left; }
table.md-table td { min-width: 80px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
pre { white-space: pre-wrap; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; page-break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit inherit; background-repeat: inherit inherit; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
.md-fences .CodeMirror.CodeMirror-wrap { top: -1.6em; margin-bottom: -1.6em; }
.md-fences.mock-cm { white-space: pre-wrap; }
.show-fences-line-number .md-fences { padding-left: 0px; }
.show-fences-line-number .md-fences.mock-cm { padding-left: 40px; }
.footnotes { opacity: 0.8; font-size: 0.9rem; padding-top: 1em; padding-bottom: 1em; }
.footnotes + .footnotes { margin-top: -1em; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background-color: transparent; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: normal; text-align: left; box-sizing: content-box; direction: ltr; background-position: initial initial; background-repeat: initial initial; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li p, li .mathjax-block { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; }
@media print { 
  html, body { height: 100%; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  h1, h2, h3, h4, h5, h6 { page-break-after: avoid; break-after: avoid-page; orphans: 2; }
  p { orphans: 4; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 1cm; padding-right: 1cm; }
  .typora-export #write::after { height: 0px; }
  @page { margin: 20mm 0mm; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 2.86rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; background-position: initial initial; background-repeat: initial initial; }
p .md-image:only-child { display: inline-block; width: 100%; text-align: center; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.mathjax-block { white-space: pre; overflow: hidden; width: 100%; }
p + .mathjax-block { margin-top: -1.143rem; }
.mathjax-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: none; box-shadow: none; }
.task-list { list-style-type: none; }
.task-list-item { position: relative; padding-left: 1em; }
.task-list-item input { position: absolute; top: 0px; left: 0px; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc::after, .md-toc-content::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); text-decoration: none; }
.md-toc-inner:hover { }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: bold; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: '.'; }
.md-tag { opacity: 0.5; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: monospace; }
code { text-align: left; }
h1 .md-tag, h2 .md-tag, h3 .md-tag, h4 .md-tag, h5 .md-tag, h6 .md-tag { font-weight: initial; opacity: 0.35; }
a.md-print-anchor { border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: none !important; background-color: transparent !important; text-shadow: initial !important; background-position: initial initial !important; background-repeat: initial initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.mathjax-block .MathJax_SVG_Display { text-align: center; margin: 1em 0em; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: monospace; }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: normal; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { -webkit-transition: none; transition: none; }


@import-when-export url(http://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic);
@import-when-export url(http://fonts.googleapis.com/css?family=Lato:900,300);


/**
 * forked from pixyll.com
 * MIT license
 */

@charset "UTF-8";
@font-face {
	font-family: 'Merriweather';
	font-style: normal;
	font-weight: 300;
	src: local('Merriweather Light'), local('Merriweather-Light'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Merriweather-Light.ttf);
}
@font-face {
	font-family: 'Merriweather';
	font-style: normal;
	font-weight: 900;
	src: local('Merriweather Heavy'), local('Merriweather-Heavy'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Merriweather-Bold.ttf);
}
@font-face {
	font-family: 'Merriweather';
	font-style: italic;
	font-weight: 300;
	src: local('Merriweather Light Italic'), local('Merriweather-LightItalic'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Merriweather-LightItalic.ttf);
}
@font-face {
	font-family: 'Merriweather';
	font-style: italic;
	font-weight: 900;
	src: local('Merriweather Heavy Italic'), local('Merriweather-HeavyItalic'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Merriweather-HeavyItalic.ttf);
}

@font-face {
	font-family: 'Lato';
	font-style: normal;
	font-weight: 300;
	src: local('Lato Light'), local('Lato-Light'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Lato-Light.ttf);
}
@font-face {
	font-family: 'Lato';
	font-style: normal;
	font-weight: 900;
	src: local('Lato Black'), local('Lato-Blcak'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Lato-Black.ttf);
}
@font-face {
	font-family: 'Lato';
	font-style: normal;
	font-weight: bold;
	src: local('Lato Black'), local('Lato-Blcak'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Lato-Black.ttf);
}
@font-face {
	font-family: 'Lato';
	font-style: italic;
	font-weight: 900;
	src: local('Lato BlackItalic'), local('Lato-BlackItalic'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Lato-BlackItalic.ttf);
}
@font-face {
	font-family: 'Lato';
	font-style: italic;
	font-weight: bold;
	src: local('Lato BlackItalic'), local('Lato-BlackItalic'), url(file:///Users/hite/Library/Application%20Support/abnerworks.Typora/themes/pixyll/Lato-BlackItalic.ttf);
}

h1,
.h1,
.f1 {
	font-size: 2rem;
	line-height: 2.5rem;
}
h2,
.h2,
.f2 {
	font-size: 1.5rem;
	line-height: 2rem;
}
h3,
.h3,
.f3 {
	font-size: 1.25rem;
	line-height: 1.5rem;
}
p,
.p,
.f4,
h4,
h5,
h6,
dl,
ol,
ul,
pre[cid],
div[cid],
#typora-source {
	font-size: 1.125rem;
	line-height: 1.5rem;
}

h4 {
	font-size: 1.13rem;
}
/*
 Pixyll
 A simple, beautiful theme for Jekyll that emphasizes content rather than aesthetic fluff.
 Best served with BASSCSS (http://jxnblk.github.io/basscss)
 Crafted with <3 by John Otander (@4lpine) - ©2015 John Otander MIT License http://opensource.org/licenses/MIT

*/

body {
	font-family: "Merriweather", "PT Serif", Georgia, "Times New Roman", "STSong", Serif;
	line-height: 1.5rem;
	font-weight: 400;
}

#write {
	max-width: 914px;
	color: #333;
}

img {
	width: auto;
	max-width: 100%;
}
body {
	font-size: 1.5rem;
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
}

.md-table-edit {
	background: #ededed;
    padding-top: 4px;
}

table {
	width: 100%;
	font-size: 1.125rem;
}
table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td,
table > tfoot > tr > th,
table > tfoot > tr > td {
	padding: 12px;
	line-height: 1.2;
	vertical-align: top;
	border-top: 1px solid #333;
}
table > thead > tr > th {
	vertical-align: bottom;
	border-bottom: 2px solid #333;
}
table > caption + thead > tr:first-child > th,
table > caption + thead > tr:first-child > td,
table > colgroup + thead > tr:first-child > th,
table > colgroup + thead > tr:first-child > td,
table > thead:first-child > tr:first-child > th,
table > thead:first-child > tr:first-child > td {
	border-top: 0;
}
table > tbody + tbody {
	border-top: 2px solid #333;
}
p {
	font-weight: 300;
	line-height: 1.5;
}
abbr {
	border-bottom: 1px black dotted;
	cursor: help;
}
pre,
code {
	font-family: Menlo, Monaco, "Courier New", monospace;
}

code,
.md-fences  {
	color: #7a7a7a;
}

.md-fences .CodeMirror.CodeMirror-wrap {
	top: -1.5em;
    margin-bottom: -1.5em;
}

.md-fences {
	padding: 1.125em;
	margin-bottom: 0.88em;
	font-size: 1rem;
	border: 1px solid #7a7a7a;
}

blockquote {
	padding: 1.33em;
	font-style: italic;
	border-left: 5px solid #7a7a7a;
	color: #555;
}
blockquote em {
	color: #000;
}
blockquote footer {
	font-size: .85rem;
	font-style: normal;
	background-color: #fff;
	color: #7a7a7a;
	border-color: transparent;
}
h1,
.h1,
h2,
.h2,
h3,
.h3,
h4,
.h4,
h5,
.h5,
h6,
.h6 {
	font-family: "Lato", 'Helvetica Neue', Helvetica, sans-serif;
	font-weight: 900;
	line-height: 1.2;
	margin: 1em 0 0.5em;
}
@media screen and (min-width: 48em) {
	.h1,
	h1 {
		font-size: 3.250rem;
	}
	.h2,
	h2 {
		font-size: 2.298rem;
	}
	.h3,
	h3 {
		font-size: 1.625rem;
	}
	.h4,
	h4 {
		font-size: 1.3rem;
	}
	#write>h4.md-focus:before,
	#write>h5.md-focus:before,
	#write>h6.md-focus:before{
		top: 1px;
	}
	.p,
	p,
	li {
		font-size: 1.25rem;
		line-height: 1.8;
	}
	table {
		font-size: 1.25rem;
	}
}
@media (max-width: 48em) {
	blockquote {
		margin-left: 1rem;
		margin-right: 0;
		padding: 0.5em;
	}
	.h1,
	h1 {
		font-size: 2.827rem;
	}
	.h2,
	h2 {
		font-size: 1.999rem;
	}
	.h3,
	h3 {
		font-size: 1.413rem;
	}
	.h4,
	h4 {
		font-size: 1.3rem;
	}
}
@media screen and (min-width: 64em) {
	.h1,
	h1 {
		font-size: 4.498rem;
	}
	.h2,
	h2 {
		font-size: 2.29rem;
	}
	.h3,
	h3 {
		font-size: 1.9rem;
	}
	.h4,
	h4 {
		font-size: 1.591rem;
	}
	#write>h4.md-focus:before{
		top:4px;
	}
}
a {
	color: #463F5C;
	text-decoration: underline;
}

#write {
	padding-top: 2rem;
}

#write pre.md-meta-block {
	min-height: 35px;
	padding: 0.5em 1em;
	white-space: pre;
	border: 0px;

	border-left: 30px #f8f8f8 solid;
	border-right: 30px #f8f8f8 solid;
	width: 100vw;
	max-width: calc(100% + 60px);

	margin-left: -30px;
	margin-bottom: 2em;
	margin-top: -2010px;
	padding-top: 2000px;
	padding-bottom: 10px;
	line-height: 1.5em;
	color: #7a7a7a;
	background-color: #fafafa;
	font-family: 'Lato', 'Helvetica Neue', Helvetica, sans-serif;
	font-weight: 300;
	clear: both;
	padding-left: 0;
	font-size:1.125rem;
}
.md-image>.md-meta {
	color: #463F5C
}
.footnotes {
	font-size:1.1rem;
}
.md-tag {
	font-family: 'Lato', 'Helvetica Neue', Helvetica, sans-serif;
}
.code-tooltip {
	background: white;
}
.code-tooltip-content {
	font-size: 1.1rem;
}

.task-list{
	padding-left: 0;
}

.task-list-item {
	padding-left:34px;
}

.task-list-item input{
	width: 1.25rem;
	height: 1.25rem;
	display: block;
	-webkit-appearance: initial;
	top: -2px;
}

.task-list-item input:focus{
	outline: none;
	box-shadow: none;
}

.task-list-item input:before{
	border: 1px solid #555;
	border-radius: 1.5rem;
	width: 1.5rem;
	height: 1.5rem;
	background: #fff;
	content: ' ';
	transition: background-color 200ms ease-in-out;
	display: block;
}

.task-list-item input:checked:before,
.task-list-item input[checked]:before{
	background: #333;
	border-width: 2px;
	display:inline-block;
	transition: background-color 200ms ease-in-out;
}

.task-list-item input:checked:after,
.task-list-item input[checked]:after {
	opacity: 1;
}

.task-list-item input:after {
	opacity: 1;
	-webkit-transition: opacity 0.05s ease-in-out;
	-moz-transition: opacity 0.05s ease-in-out;
	transition: opacity 0.05s ease-in-out;
	-webkit-transform: rotate(-45deg);
	-moz-transform: rotate(-45deg);
	transform: rotate(-45deg);
	position: absolute;
	top: 0.4375rem;
	left: 0.28125rem;
	width: 0.9375rem;
	height: 0.5rem;
	border: 3px solid #fff;
	border-top: 0;
	border-right: 0;
	content: ' ';
	opacity: 0;
}

.md-tag {
	color:inherit;
}

.md-toc:focus .md-toc-content{
	margin-top: 19px;
}

#outline-dropmenu {
	background-color:white;
	font-size:1rem !important;
}

#outline-content li, #outline-content ul {
	font-size:1rem !important;
}

.outline-title {
	line-height: inherit;
	margin-top: 10px;
}

.outline-expander {
	width: 18px;
}

.outline-expander:before {
 	content: "+";
	font-family: inherit;
	color: rgb(108, 108, 108); 
  	font-size: 1.5rem;
 	top: 0.1rem;
}

.outline-expander:hover:before {
	content: "+";
}

.outline-item-open>.outline-item>.outline-expander:before{
	content: "-";
}

/** source code mode */
#typora-source {
	font-family: Courier, monospace;
    color: #6A6A6A;
}

.os-windows #typora-source {
	font-family: inherit;
}

.cm-s-typora-default .cm-header, 
.cm-s-typora-default .cm-property,
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor {
	color: #428bca;
}

.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number {
	color: #777777;
}


.md-diagram-panel {
	margin-top: 24px;
	margin-left: -1.2em;
}


</style>
</head>
<body class='typora-export' >
<div  id='write'  class = 'is-mac'><h1><a name='header-c5' class='md-header-anchor '></a>APP主题测试自动化：Fastlane篇</h1><p>本文算是“<a href='http://ks.netease.com/blog?id=7839'>从视觉到App：网易有钱iOS项目主题自动化方案</a>”的补充。
行文的主要目的是展示如何用fastlane工具，做多主题在多设备上的测试任务，所以不会对fastlane做全面系统的介绍。但如果在自动化任务中用到fastlane相关技术点，重要的细节、坑或者最佳实践，会在相应的步骤特别的说明。</p><h2><a name='header-c10' class='md-header-anchor '></a>文章大纲</h2><ol start='' ><li>Fastlane概述，包括fastlane的前世今生，fastlane的整体结构</li><li>如何使用Fastlane实现主题测试自动化，步骤分解</li><li>定制输出结果，编写Fastlane的action</li><li>Fastlane使用的注意事项</li></ol><h2><a name='header-c24' class='md-header-anchor '></a>1. Fastlane概述</h2><p>Fastlane 作者Felix Krause，于2014年创造了fastlane项目，一年后的2015年被fabric收购，在此之前的2014年，fabric被Crashlytics收购，而Twitter则在2013年收购了Crashlytics。自2015起，作者一直在Twitter开发fastlane，直到2017年Google收购了fabric，现在在Google全职开发fastlane。
从履历上看，fastlane的背后有强大的公司支持和实践，近年来发展势头很好，更新迭代很快。（在前段时间iTunes更改了后台登录的验证方式之后，fastlane团队第一时间获取信息，发布了公告,在一周内fix）。下图是fastlane的工具总览。</p><p><img src='http://upload-images.jianshu.io/upload_images/277783-14bde6327ba7c8c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='intro-fastlane-tree.png' /></p><p>上图的每一条线都是一个lane（后文统一翻译为<code>任务</code>），而在每个lane上的节点，则是fastlane的action，如图中的pilot。每个lane都是一个业务，业务由各种不同的action组合，使用ruby的语法封装的逻辑。
<strong>什么是fastlane的action</strong>
fastlane的action可以简单的认为是一个功能模块，部分action如下表格所列。</p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>deliver</td><td>自动上传截图，APP的元数据，二进制(ipa)文件到iTunes Connect</td></tr><tr><td>snapshot</td><td>自动截图（基于Xcode7+的UI test）</td></tr><tr><td>frameit</td><td>可以把截的图片自动套上一层外边框</td></tr><tr><td>pem</td><td>自动生成、更新推送配置文件</td></tr><tr><td>sigh</td><td>用来创建、更新、下载、修复Provisioning Profile的工具</td></tr><tr><td>pilot</td><td>管理TestFlight的测试用户，上传二进制文件</td></tr><tr><td>scan</td><td>自动运行测试工具，并且可以生成漂亮的HTML报告</td></tr></tbody></table><p>以上都是fastlane内置的actions，事实上，我们可以自己编写actions，那么fastlane内置的actions和我们自定的actions有没有区别呢？
<strong>fastlane内置的action的特殊之处</strong></p><ol start='' ><li>fastlane内置的action，可以直接在命令行里直接运行，如<code>fastlane snapshot</code>，而自定义的action，如后文提到的<code>resort_screenshot</code>，在运行的时候需要使用语法<code>fastlane run resort_screenshot</code></li><li>内置action有相应的配置文件，如snapshot相应的snapFile，定义了action需要的参数。（事实上fastlane本身也有一个配置文件fastFile）</li><li>假设，你在fastFile（fastlane的配置文件）里创建了一个和内置action重名的lane如<code>snapshot</code>，则<code>fastlane snapshot</code>命令读取到的是内置action，而不是作为lane的<code>snapshot</code></li></ol><p>和actions相关了两个命令，<code>fastlane actions</code>输出里包含了内置的action和自定义的action。</p><pre class="md-fences md-end-block" lang="bash"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">fastlane actions <span class="cm-comment"># list all available fastlane actions</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">fastlane action [action_name] <span class="cm-comment"># more information for a specific action</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 42px;"></div></div></div></pre><p><a href='https://fastlane.tools/'>Fastlane</a>本质上是一系列符合Fastlane规范工具的执行环境。这些工具处于fastlane的管理之下，可以使用fastlane的全局变量、credentials_manager、上游action的输出等数据。fastlane对编写action时，经常使用的组件或util，做了简单的封装，使每个action的行为表现保存一致。如在控制台输出错误提示信息可以使用以下语法</p><pre class="md-fences md-end-block" lang="ruby"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-variable">puts</span> <span class="cm-string">"Must name a themeServerId"</span><span class="cm-operator">.</span><span class="cm-variable">red</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-tag">UI</span><span class="cm-operator">.</span><span class="cm-variable">error</span>(<span class="cm-string">"Must name a themeServerId"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 42px;"></div></div></div></pre><p>每个lane执行完毕，在控制台都会有相应的统计数据，样式完全一致。<strong>fastlane是ruby的一个gem——为了定制自己的actions，你需要了解ruby的基本使用。</strong></p><p>如果需要了解详细的关于fastlane的信息，请访问官网docs，<a href='https://docs.fastlane.tools/getting-started/ios/setup/'>Getting started with fastlane for iOS</a></p><h2><a name='header-c82' class='md-header-anchor '></a>2. 主题测试自动化步骤 for iOS</h2><h3><a name='header-c83' class='md-header-anchor '></a>2.1 安装fastlane</h3><p>确保安装了ruby，版本在2.00以上。有三种方式安装fastlane，推荐使用gem方式。</p><p><code>sudo gem install fastlane -NV</code></p><p>如果没有安装 Xcode command line tools，也要安装</p><p><code>xcode-select --install</code></p><p>安装成功之后运行<code>fastlane env</code>，输出如</p><blockquote><p>[14:10:50]: Generating fastlane environment output, this might take a few seconds...<br/>
<summary>🚫 fastlane environment 🚫</summary>
// 此处省略其余信息<br/></p></blockquote><p>即为成功。如果失败了，fastlane在输出错误信息的同时，很智能的会在open或者closed的github的issues查找相关的解决方案，输出在console里，供我们去对应的fix。</p><p>能够智能的提供错误解决方案，得益于前面演示的<code>fastlane env</code>，当想fastlane的github工程里提issue时候，github的机器上fastlane-bot 会提示你请提供<code>fastlane env</code>。这是个非常非常聪明的作法，利用众包的方式发现问题、解决问题。李飞飞的ImageNet的诞生也离不开众包，进行有监督的学习。</p><h3><a name='header-c103' class='md-header-anchor '></a>2.2 初始化fastlane</h3><p>在<code>.xcodeproj</code>文件所在的文件夹下执行</p><p><code>fastlane init</code></p><p>会在当前目录下生成一个<code>/fastlane</code>的文件夹。此后所有的fastlane相关文件都会在此文件夹下。</p><p>本流程不需要<code>app_identifier、apple_id、team_id</code>的数据，所以不需要Appfile，此处略过。
在生成的文件里，其中最重要的是Fastfile。这个文件的整个fastlane 工作流的核心和入口，所有的流程、功效变量等都在这个文件里。他的结构是这样的。</p><pre class="md-fences md-end-block" lang="ruby"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">fastlane_version</span> <span class="cm-string">"2.14.2"</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">default_platform</span> <span class="cm-atom">:ios</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">platform</span> <span class="cm-atom">:ios</span> <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">before_all</span> <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-variable">cocoapods</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">lane</span> <span class="cm-atom">:test</span> <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">lane</span> <span class="cm-atom">:beta</span> <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">desc</span> <span class="cm-string">"制作AppStore版本"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">lane</span> <span class="cm-atom">:release</span> <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">after_all</span> <span class="cm-keyword">do</span> |<span class="cm-def">lane</span>|</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">error</span> <span class="cm-keyword">do</span> |<span class="cm-def">lane</span>, <span class="cm-def">exception</span>|</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 564px;"></div></div></div></pre><p>说明（引用自<a href='http://blog.devzeng.com/blog/ios-fastlane-in-action.html'>iOS中fastlane的使用</a>）：</p><ul><li>（1）fastlane_version：指定fastlane使用的最小版本</li><li>（2）default_platform：指定当前默认的平台，可以选择ios/android/mac</li><li>（3）before_all：在执行每一个lane之前都会调用这部分的内容</li><li>（4）after_all：在每个lane执行完成之后都会执行这部分的内容</li><li>（5）error：每个lane执行出错就会执行这部分的内容</li><li>（6）desc：对lane的描述，fastlane会自动将desc的内容生成说明文档</li><li>（7）lane：定义一个lane(任务)，我们在执行的时候使用fastlane [ios] lane名称</li></ul><p>可以看到，<code>before_all</code>在每个lane执行前都会执行，是个理想的设置全局变量的地方。</p><pre class="md-fences md-end-block" lang="ruby"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">lane</span> <span class="cm-atom">:test</span> <span class="cm-keyword">do</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">cert</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">sigh</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">gym</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">end</span> </span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 105px;"></div></div></div></pre><p>可以定义一个具体的任务，提供给外部调用，如<code>fastlane test</code> （在Fastfile里可以定义私有lane，详细语法见docs，<a href='https://docs.fastlane.tools/advanced/#private-lanes'>Private lanes部分</a>）。</p><p>以上就是基础的fastlane的配置文件，如果需要单独执行内置的命令，如snapshot，则可以提供Snapfile。所有的内置actions都会有配套的配置文件。内置actions除了可以在命令行<code>fastlane snapshot</code>这样调用外，可以在lane的定义里使用。如</p><pre class="md-fences md-end-block" lang="ruby"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">lane</span> <span class="cm-atom">:test_ui_test</span> <span class="cm-keyword">do</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">increment_build_number</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">cocoapods</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">match</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-operator">...</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">snapshot</span>(</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-atom">reinstall_app:</span> <span class="cm-keyword">true</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-atom">skip_open_summary:</span> <span class="cm-keyword">true</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-atom">clear_previous_screenshots:</span> <span class="cm-keyword">false</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-atom">launch_arguments:</span> [<span class="cm-variable">args</span>],</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-atom">devices:</span> <span class="cm-variable">devices</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  )</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">testflight</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">sh</span> <span class="cm-string">"./customScript.sh"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">slack</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 358px;"></div></div></div></pre><p>有了入口文件，将测试主题的lane命名为<code>test_ui_test</code>，使用若干actions，如snapshot等内部action，结合普通的ruby语句，我们就可以开始实现自动化截图任务逻辑了。</p><h3><a name='header-c147' class='md-header-anchor '></a>2.3 主题测试后自动化需求和方案</h3><p><strong>1. 需求说明</strong><br/>
有钱的iOS2.7.5增加了主题功能，用户可以选择自己喜欢主题，主题数量大概有7种，在制作过程中，发现需要适配iPhone6、iPad、其他iPhone。所以看起来我们需要对<code>7 * 3 = 21</code>种情况来检查（暂时不考虑多语言），除了需要切换不同主题外，还需要切换3种设备。 加上主题的配色其实还在迭代中，一旦改动又需要重复的走一遍流程，这个流程对QA而已机械重复而无趣。</p><p>所以，我们的目标是如何自动化这部分工作。<br/>
<strong>2. 思路</strong> <br/>
多设备适配，可以通过指定snapshot的配置参数<code>devices = [&quot;iPhone 5&quot;, &quot;iPhone 6&quot;, &quot;iPad Air&quot;]</code>来实现。那如何定义多主题测试呢？总不能默认执行所有皮肤吧——我们需要指定本次测试需要测试哪些皮肤。根据项目情况，决定用主题的服务端配置的id来标示（themeServerId），并且themeServerId有一个对应关系。如下表格</p><table><thead><tr><th>主题serverId</th><th>主题名称</th></tr></thead><tbody><tr><td>5017</td><td>粉红物语</td></tr><tr><td>8002</td><td>月宫玉兔</td></tr><tr><td>8003</td><td>海底世界</td></tr><tr><td>8004</td><td>缤纷几何</td></tr><tr><td>8005</td><td>宁静夏夜</td></tr></tbody></table><p><strong>最终方案是：在执行fastlane 命令的时候去指定主题id，可以指定多个主题，这样就可以实现测试多个主题。但是这个方案遇到一个难题——如何在命令行传参数给app传值。</strong></p><h2><a name='header-c178' class='md-header-anchor '></a>为什么会采用这种方案？</h2><p><strong>2.1 有钱的主题的更新机制。</strong><br/>
有钱的主题是通过用户在界面选择主题类型，代码里触发</p><pre class="md-fences md-end-block" lang="objective-c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">[[<span class="cm-variable">MKThemeCacheManager</span> <span class="cm-variable">sharedManager</span>] <span class="cm-variable">downloadThemeWithServerId</span>:<span class="cm-variable">serverId</span>]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p>来实现皮肤的下载。 <br/>
<strong>2.2 fastlane工具链流的限制。</strong><br/></p><p>在输入了命令<code>fastlane test_ui_test</code>后，fastlane去调用XCUITest，然后XCUITest启动有钱的APP（<strong>重要的一点，XCUITest只是对有钱APP的代理</strong>），在XCUITest运行阶段只有受限的接口去和APP交互；运行前，更不能直接调用MKThemeCacheManager的方法。 而且fastlane和XCUITest也无法通讯。<br/></p><p><strong>2.3 在翻阅了大量fastlane相关参数、XCUITest相关参数、启动APP相关参数，发现snapshot的参数里有个宝贝——<code>launch_arguments</code>.</strong></p><pre class="md-fences md-end-block" lang="ruby"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">snapshot</span>(</span></pre></div><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-comment"># reinstall_app: true,</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-atom">skip_open_summary:</span> <span class="cm-keyword">true</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-atom">clear_previous_screenshots:</span> <span class="cm-keyword">false</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-atom">launch_arguments:</span> [<span class="cm-variable">args</span>],</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-atom">devices:</span> <span class="cm-variable">devices</span></span></pre><pre class=""><span style="padding-right: 0.1px;">)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 147px;"></div></div></div></pre><p>snapshot的configuration file即<code>SnapshotHelper.swift</code>获取到snapshot注入的<code>launch_arguments</code>参数，并且在XCUITest启动的时候设置APP的启动<code>launch_arguments</code>。然而XCUITest却拿不到这个参数，但是APP却是可以拿到的——是Session级别的NSUserDefaults数据。使用下列的语句获取传入的themeServerId。</p><pre class="md-fences md-end-block" lang="objective-c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">[[<span class="cm-variable">NSUserDefaults</span> <span class="cm-variable">standardUserDefaults</span>] <span class="cm-variable">objectForKey</span>:<span class="cm-keyword">@</span><span class="cm-string">"themeServerId"</span>]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p>在APP的首页拿到这个参数，那么就可以在内部使用这个参数调用</p><pre class="md-fences md-end-block" lang="objective-c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">[[<span class="cm-variable">MKThemeCacheManager</span> <span class="cm-variable">sharedManager</span>] <span class="cm-variable">downloadThemeWithServerId</span>:<span class="cm-variable">serverId</span>]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p>下载皮肤，注意：在XCUITest里需要处理下载皮肤的等待。</p><p>OK，从fastlane的内置action之snapshot传值给app的路走通了，如何在fastlane的命令行（比如，我们输入themeServerId变量是终端里，而不是去每次去修改Fastfile里的参数<code>launch_arguments</code>）。经过一番搜寻，在<code>fastlane.tools</code>的advanced.md模块找到了答案。<a href='https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Advanced.md'>fastlane/Advanced.md at master · fastlane/fastlane · GitHub</a>。形如</p><pre class="md-fences md-end-block" lang="bash"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">fastlane test_ui_test themeServerId:8004</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p>，就可以传值给内置命令snapshot的配置数据。</p><p><strong>2.3 实现任务逻辑（lane）</strong><br/></p><p><strong>2.3.1 编写fastFile文件</strong>。
在<code>lane :test_ui_test</code>里编写逻辑——获取themeServerId 、需要测试设备类型，2个参数，然后将获取的参数传入 内置action之snapshot，最后打开截图的summary界面的逻辑。</p><p><strong>2.3.2 编写截图的逻辑。</strong>
在<code>MoneyKeeperUITests.swift</code>文件里编写截图代码。包括截图内容、截图顺序。</p><blockquote><p>良好配置的测试用例，可以减少测试次数，优化测试方案，节省时间</p></blockquote><p>按照需求，需要截取6个关键界面，但前提是需要先下载到某个主题——可以通过触发下载后，等18s来完成。
另外，在正在进入第一个关键页面，即首页前，可能会有新手引导的一系列界面，所以需要排除掉新手引导的干扰。</p><p><strong>2.3.3 对截图的分组展示和区分。</strong>
如果过使用默认的截图总览界面，你会发现多次截图都混着一起，浏览的交互方式也很差劲如图；</p><p><img src='http://upload-images.jianshu.io/upload_images/277783-a9fa95358df3cb57.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='默认的截图汇总界面' /></p><p>所以需要一个更好的交互方式、界面组织方式，经过一番思索。对现有的结构做了如下改进</p><ul><li>A、每次测试后的截图为一组，而且默认一组的展示不需要左右滑动。需要查看所有图片的时候，可以弹窗展示，不需要横向纵向滚动条。</li><li>B、多次截图，按照先后顺序，向下排列，避免出现左右滚动条。</li><li>C、当皮肤数量很多时，可以在纵向扩展</li></ul><p>这就意味着需要自己定制，按照官网的步骤，写<code>resort_screenshot</code>的action，这个后面会详细讲到逻辑实现。这里只需要明白一点：</p><blockquote><p><code>resort_screenshot</code>对snapshot的截图汇总界面和图片素材做了二次处理</p></blockquote><p>而实现的，并且保留了snapshot原生自己汇总界面。所以在<code>lane :test_ui_test</code>里，执行截图命令之后，接着执行如下代码，</p><pre class="md-fences md-end-block" lang="ruby"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">resort_snapshot</span>(<span class="cm-atom">skip_open_summary:</span> <span class="cm-variable">skipOpenSummary</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p>其中skipOpenSummary表示是否不需要自动打开截图的结果页面。这个选项在测试机上是YES，因为测试是执行完毕之后，会返回一个url，供QA点击在QA本地浏览器打开——并不需要在测试机上打开。</p><h2><a name='header-c245' class='md-header-anchor '></a>3.resort_screenshot 的action编写</h2><p>这里需要特殊说明下action 、plugin 和fastlane的关系。
Action是fastlane里基础的逻辑代码，完成一个特定任务，可以在各个lane的定义里使用，但是只能在内部使用；而plugin则是对action的封装，确定当前action可以依赖的其他plugin的action。个良好的plugin可以发布到github之类的地方，供别人在自己的Fastfile里使用。打个比方，</p><blockquote><p>plugin是npm系统里的一个 node_module，而action，可能是node_module里的一个JS文件，是单纯的代码的package</p></blockquote><p><strong>3.1 如何编写action</strong><br/>
在命令行输入</p><pre class="md-fences md-end-block" lang="bash"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">fastlane new_action</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p>接着输入action的名字，这里我们输入<code>resort_screenshot</code>，然后会生成
<code>/fastlane/actions/[action_name].rb</code><br/>
打开这个文件，在对应的模板处编写逻辑。</p><p>查看snapshot现有的截图之后的汇总结果的素材和最后的html结构，发现这些图都在同一个文件夹，命名是切图序列+自定义文字。如何在多次截图的文件夹里，对每一个主题分组呢？这就需要自定义文字里包含本次截图的数据——换言之，</p><blockquote><p>如何把themeServerId传给XCUITest?</p></blockquote><p>前面已经说过，从fastlane端是不行的；只剩下从APP里向XCUITest传值。</p><p><strong>3.2 APP里向XCUITest传值</strong></p><p>经过仔细查找，发现XCUITest可以获取到App UIElement里的label，也就是UIControl 的属性<code>accessibilityLabel</code>。 所以解决方案是 从fastlane获取的数据写到UIControl的accessibilityLabel，然后XCUITest获取到<code>themeServerId</code>，作为截图文件的名字的一部分。</p><p><strong>3.3 XCUITest向<code>resort_screenshot</code>传值</strong></p><p>正如上述，因为XCUITest获取到<code>themeServerId</code>，作为截图文件的名字的一部分。所以<code>resort_screenshot.rb</code>文件读取到图片文件的名字，经过一次循环之后，获取到了分组的类型和数量，包含<code>themeServerId</code>。resort_screenshot.rb<code>可以获取到</code>themeServerId`，传值完成。</p><blockquote><p>注意：XCUITest向<code>resort_screenshot</code>传值，传那些数据是密切和业务相关的，同时在<code>resort_screenshot.erb</code>文件对从XCUITest获取到的数据截取也是非常业务相关的。<B>后文提供的action的源码其实不是开箱即用的，需要在XCUITest的代码埋数据，在<code>resort_screenshot.rb</code>截取数据，传递给<code>resort_screenshot.erb</code>渲染</B></p></blockquote><p>至此，整个流程就走通了。整体数据的流向图是，</p><p><img src='http://upload-images.jianshu.io/upload_images/277783-b945aeaba96f8c0a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='数据流的走向和实现方式' /></p><p>下面演示如何使用。</p><h3><a name='header-c284' class='md-header-anchor '></a>如何使用</h3><p>在流程走通之后，需要移交给QA，让他们可以在测试机上测试。在测试机上的Nginx html目录下新增了一个软连接。</p><pre class="md-fences md-end-block" lang="bash"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">screenshots <span class="cm-attribute">-</span>&gt; /Users/deploy/workspace/moneyKeeper/src/MoneyKeeper/fastlane/screenshots</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 42px;"></div></div></div></pre><p>当一个case如命令<code>fastlane test_ui_test themeServerId:8002,8005 devices:&quot;iPhone 5&quot;</code>，测试完毕之后，自动打开浏览器，地址形如</p><pre class='md-fences mock-cm' style='display:block;position:relative'>http://iospack.youqian/screenshot/resort_screenshot.html</pre><blockquote><p>作为对照，你还可以打开snapshot默认的结束汇总界面。<code>http://iospack.youqian/screenshot/screenshot.html</code></p></blockquote><p>就可以看到测试结果了，这个测试结果地址可以给产品、或者视觉，供他们走查。</p><h2><a name='header-c297' class='md-header-anchor '></a>关于<code>fastlane test_ui_test</code>的参数</h2><p>完整的命令如，<code>fastlane test_ui_test themeServerId:8002,8005 devices:&quot;iPhone 5&quot;</code>。有两个参数，</p><ol start='' ><li>一个是themeServerId，接受<code>8002, 8005</code>这样的value，表示本次需要截图的主题有哪些，必需参数，这些参数对应前文表格数据，是业务相关不具有通用性。</li><li>第二个是devices，表示在哪些设备上截图。选填，默认是iPhone 5，可以是多个，如&quot;iPhone 5, iPhone 6 PLUS&quot;。但不推荐一次性测试多个设备，因为切换iPhone、iPad模拟器比较耗时。</li></ol><p>让我们开始吧。我们的目的是测试themeServerId是8002,8005的两个皮肤的展示是否正确。执行<code>fastlane test_ui_test themeServerId:8002,8005</code> ，经过一段时间编译之后会自动打开iPhone 5模拟器，自动截图，结束之后，会在控制台输出类似以下的信息，</p><p><img src='http://upload-images.jianshu.io/upload_images/277783-bc5d2948249cee98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='fastlane执行结束的统计数据' /></p><p>当次执行的时间统计，这也是fastlane做工具聚合比较有用的一点——它的输出比较美观。
并同时打开浏览器，会看到：</p><p><img src='http://upload-images.jianshu.io/upload_images/277783-a39ebf6624580f4d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='列表模式' /></p><p>每个皮肤的测试作为一个组，以扇形显示。这样不会有横向滚动条。点击某个扇形里的图片，会打开这张图片，进入大图浏览模式，可以使用左右箭头、或者键盘上的左右按钮来切换图片。</p><p><img src='http://upload-images.jianshu.io/upload_images/277783-3251040602c2cf58.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='大图浏览模式' /></p><p>至此，大功告成。</p><p>其实为了实现这个功能，中间走了很多的弯路，下一节会集中列出来这些坑，或者某些注意事项，让刚刚接触到的人能够避开。</p><h2><a name='header-c324' class='md-header-anchor '></a>4.注意事项（坑集锦）</h2><ol start='' ><li>如果要使用工具链里的match、cert、sign等需要升级openssl到2.0（登录apple developer portal需求）</li><li>为什么不通过<code>brew cask install fastlane</code> 来安装呢？通过这种命令安装的fastlane，所引用的ruby版本可能是系统默认的版本，如果你有多个ruby安装在系统上，会遇到很多无法预知的情况</li><li><code>sudo gem install fastlane -NV</code>之后不一定成功，运行完毕之后，检查出错在哪儿，最常见的错误是ruby版本不对，如果需要多个ruby版本存在，推荐使用rbenv。</li><li>用老版本的fastlane，执行了<code>fastlane init</code>之后提示需要输入<code>app identifier</code>等数据，如果不使用match、sign工具的，可以直接skip过去。不需要创建Appfile</li><li>Fastfile的写法很灵活，官网上很很多例子供我们参考，可以拿来吸取灵感。</li><li>细心的读者会发现，其实<code>SnapshotHelper.swift</code>是可以拿到snapshot注入的参数，那么我们的主测试代码里也可以拿到的，那为什么说XCUITest和fastlane不能通讯呢？ 是的，其实是可以通讯的，但是snapshot注入的<code>launch_arguments</code>是snapshot自己通过创建了一个中间的<code>snapshot-launch_arguments.txt</code>文件来传递数据，作为一个不属于fastlane体系的类，不应该依赖从黑盒中拿到的逻辑来实现自己的目的——所以我们认为XCUITest和fastlane之间无法直接通讯</li><li>记得经常<code>fastlane snapshot update</code>，<code>launch_arguments</code> 在某个版本<code>SnapshotHelper.swift</code>逻辑有问题，我排查了好久才发现是<code>SnapshotHelper.swift</code>的问题，更新到新版本就可以了</li><li>现在维护fastlane的质量还有一些低级的错误。例如刚刚的一个升级提示</li></ol><p><img src='http://upload-images.jianshu.io/upload_images/277783-3815be63c12b52a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='CA590D72-3F01-4E34-9107-CA0DC33DFFE3.png' /></p><p>看说明里，是各种修复语法错误，词法错误。没想到，最后的说明里还是有个拼写错误<code>ssigning</code>。真是不应该啊。</p><h2><a name='header-c354' class='md-header-anchor '></a>结语</h2><p>对于自动化测试主题这个任务，本身用到fastlane的技术不是很多，也没有很高级的技巧。本文期望作为一个科普类的文章，展示fastlane作为日常工作流程里，解决如何自动化问题的一种尝试。</p><p>在各个项目里，用fastlane可以解决什么问题，取决于自己的想象。</p><p>文末附上<code>resort_screenshot</code> <a href='https://github.com/hite/resort_screenshot.git'>action的源码</a>，再次强调——并未开箱即用，需要和XCUITest的逻辑配合使用。</p><h2><a name='header-c361' class='md-header-anchor '></a>附录参考</h2><ul><li><a href='http://www.jianshu.com/p/228354881eab'>Fastlane入门:介绍篇 - 简书</a></li><li><a href='http://blog.devzeng.com/blog/ios-fastlane-in-action.html'>iOS中fastlane的使用</a></li><li><a href='https://krausefx.com/blog/fastlane-connect-all-ios-deployment-tools-into-one-streamlined-workflow'>‘fastlane’ - Connect all iOS deployment tools into one streamlined workflow — Felix Krause</a> </li><li><a href='http://icyleaf.com/2016/07/fastlane-in-action/'>深入浅出 Fastlane 一看你就懂 ·  icyleaf</a></li></ul><hr /><p>EOF</p></div>
</body>
</html>